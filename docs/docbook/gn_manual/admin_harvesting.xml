<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
                      "http://www.docbook.org/xml/4.4/docbookx.dtd">
<book>
    <chapter id="harvesting">
        <title>Harvesting</title>
        <section>
            <title>Introduction</title>
            <para>Since the beginning of the project, there has been the need to share metadata
                among several GeoNetwork nodes. Usually, each node takes care of a region of
                interest so it is important to be able to perform a search over all these nodes at
                the same time. This is called distributed search and exploits the Internet
                connectivity. In our cases, this distributed search can be heavy to perform if there
                are many maps with associated thumbnails. Furthermore, GeoNetwork is usually
                employed in areas (like Africa, Asia) where the connectivity can be limited, making
                the use of distributed search not feasible.</para>
            <para>Harvesting is the process of collecting remote metadata and storing them
                locally for a faster access. This is a periodic process to do, for example, once a
                week. Harvesting is not a simple import: local and remote metadata are kept aligned.
                Using some <emphasis>magic</emphasis>, one GeoNetwork node is capable of discovering metadata
                that have been added, removed or updated in the remote node.</para>
            <para>GeoNetwork is able to harvest from the following sources (for more details see
                below):</para>

            <orderedlist>
                <listitem>
                    <para>Another GeoNetwork node (version 2.1 or above).</para>
                </listitem>
                <listitem>
                    <para>An old GeoNetwork 2.0 node.</para>
                </listitem>
                <listitem>
                    <para>A <glossterm linkend="glos-webdav">WebDAV</glossterm> server.</para>
                </listitem>
                <listitem>
                    <para>A <glossterm linkend="glos-csw">CSW</glossterm> 2.0.1 or 2.0.2 catalogue server.</para>
                </listitem>
                <listitem>
                    <para>An <glossterm linkend="glos-oaipmh">OAI-PMH</glossterm> server.</para>
                </listitem>
                <listitem>
                    <para>An <glossterm linkend="glos-ogc">OGC</glossterm> service using its GetCapabilities document. These include 
                        <glossterm linkend="glos-wms">WMS</glossterm>, <glossterm linkend="glos-wfs">WFS</glossterm>, 
                        <glossterm linkend="glos-wps">WPS</glossterm> and <glossterm linkend="glos-wcs">WCS</glossterm> services.</para>
                </listitem>
            </orderedlist>

        </section>
        <section>
            <title>Mechanism overview</title>
            <para>The harvesting mechanism is based on the concept of a <emphasis>universally unique identifier 
                (<glossterm linkend="glos-uuid">UUID</glossterm>)</emphasis>.
                This is a special id because it is not only
                unique locally to the node that generated it but it is unique across all the world.
                It is a combination of the network interface’s <glossterm linkend="glos-mac">MAC address</glossterm>, the current date/time
                and a random number. Every time you create a new metadata in GeoNetwork, a new UUID
                is generated and assigned to it.</para>
            <para>Another important concept behind the harvesting is the <emphasis>last change date</emphasis>. 
                Every time you change a metadata, its last change date is
                updated. Just storing this parameter and comparing it with a new one allows any
                system to find out if the metadata has been modified since last update.</para>
            <para>These two concepts allow GeoNetwork to fetch a remote metadata, check if it has
                been updated and remove it locally if it has been removed remotely. Furthermore,
                thanks to UUIDs, a hierarchy of harvesting nodes can be built where B harvests from
                C and A harvests from B. Even loops can be created because harvested metadata cannot
                be modified.</para>

        </section>
        <section>
            <title>Harvesting life cycle</title>
            <para>When a harvesting node is set, there is no harvested metadata. During the first
                run, all remote matching metadata are retrieved and stored locally. After the first
                run, only changed metadata are retrieved. Harvested metadata are not editable for
                the following reasons:</para>

            <orderedlist>
                <listitem>
                    <para>The harvesting is periodic so any local change to harvested metadata will
                        be lost during the next run.</para>
                </listitem>
                <listitem>
                    <para>The change date is used to keep track of changes so if it gets changed
                        outside the originator site, the harvesting mechanism is compromised.</para>
                </listitem>
            </orderedlist>
            <para>Beside the metadata itself, this implies that users cannot change all other
                metadata properties (like categories, privileges etc...).</para>
            <para>The harvesting process goes on until one of the following situations arises:</para>

            <orderedlist>
                <listitem>
                    <para>An administrator stops (deactivates) the node.</para>
                </listitem>
                <listitem>
                    <para>An exception arises. In this case the node is automatically
                    stopped.</para>
                </listitem>
            </orderedlist>
            <para>When a harvesting node is removed, all harvest metadata are removed too.</para>

        </section>
        <section>
            <title>Multiple harvesting and hierarchies</title>
            <para>Catalogues that provide UUIDs for metadata (for example GeoNetwork and a CSW
                server) can be harvested several times without having to take care about metadata
                overlap. This allows the possibility to perform a thematic search and a metadata
                belonging to multiple searches is harvested only once and not duplicated.</para>
            <para>This mechanism allows the GeoNetwork harvesting type to be combined with other
                GeoNetwork nodes to perform hierarchical harvesting. This way a metadata can be
                harvested from several nodes. For example, consider this scenario:</para>

            <orderedlist>
                <listitem>
                    <para>Node (A) has created metadata (a)</para>
                </listitem>
                <listitem>
                    <para>Node (B) harvests (a) from (A)</para>
                </listitem>
                <listitem>
                    <para>Node (C) harvests (a) from (B)</para>
                </listitem>
                <listitem>
                    <para>Node (D) harvests from both (A), (B) and (C)</para>
                </listitem>
            </orderedlist>
            <para>In this scenario, Node (D) will get the same metadata (a) from all 3 nodes (A),
                (B), (C). The metadata will flow to (D) following 3 different paths but thanks to
                its UUID only one copy will be stored. When (a) will be changed in (A), a new
                version will flow to (D) but, thanks to the change date, the copy in (D) will be
                updated with the most recent version.</para>

        </section>
        <section>
            <title>General notes and issues</title>

            <section>
                <title>General</title>

                <orderedlist>
                    <listitem>
                        <para>The harvesting engine does not store harvesting results. This implies
                            that if the server is restarted the last results are lost.</para>
                    </listitem>
                    <listitem>
                        <para>Changes to the harvesting parameters (for example privileges and
                            categories) are taken into account in the next harvesting run.</para>
                    </listitem>
                </orderedlist>

            </section>
            <section>
                <title>GeoNetwork harvesting type</title>

                <orderedlist>
                    <listitem>
                        <para>During harvesting, site icons are harvested and local copies updated.
                            Icons are propagated to new nodes as soon as these nodes harvest from
                            this one.</para>
                    </listitem>
                    <listitem>
                        <para>The metadata UUID is taken from the info.xml file of the MEF bundle.
                            Any UUID stored inside the metadata will be overwritten with this
                        one.</para>
                    </listitem>
                </orderedlist>

            </section>
            <section>
                <title>WebDAV harvesting type</title>

                <orderedlist>
                    <listitem>
                        <para>The same metadata could be harvested several times by different
                            harvesting nodes. Anyway, this is not a good practise because every copy
                            of the metadata will have a different UUID and the system will fill with
                            different copies of the same metadata.</para>
                    </listitem>
                </orderedlist>

            </section>
            <section>
                <title>CSW harvesting type</title>

                <orderedlist>
                    <listitem>
                        <para>If the dct:modified element is missing from the GetRecords response
                            the metadata will be always harvested.</para>
                    </listitem>
                    <listitem>
                        <para>Any exception during getRecordById operation is discarded and the
                            metadata skipped.</para>
                    </listitem>
                </orderedlist>

            </section>
            <section>
                <title>OAI-PMH harvesting type</title>

                <orderedlist>
                    <listitem>
                        <para>The id of the remote server must be a UUID. If not, metadata can be
                            harvested but during hierarchical propagation id clashes could corrupt
                            harvested metadata.</para>
                    </listitem>
                    <listitem>
                        <para>During harvesting, GeoNetwork will try to auto detect the schema of
                            each metadata. If the schema is not supported the metadata is
                        skipped.</para>
                    </listitem>
                </orderedlist>

            </section>
            <section>
                <title>OGC service harvesting type</title>

                <orderedlist>
                    <listitem>
                        <para>Every time the harvester runs, it will remove previously harvested information
                        and create new ones. GeoNetwork will generate the id for all metadata (both service and datasets).
                        Therefor, for datasets, if the metadata is created using a remote XML document (ie.
                        if a MetadataUrl tag is in the GetCapability document), the UUID of 
                        the document is used.</para>
                    </listitem>
                    <listitem>
                        <para>Thumbnails are generated only for Web Map Service (WMS). The service should also support 
                        the WGS84 projection</para>
                    </listitem>
                </orderedlist>

            </section>
        </section>
        <section>
            <title>The main page</title>
            <para>To access the harvesting main page you have to be logged in as an administrator.
                From the administration page, click the link shown in <xref
                    linkend="admin_harvesting_where"/> with a red rectangle.</para>

            <figure id="admin_harvesting_where">
                <title>How to access the harvesting main page</title>
                <mediaobject>
                    <imageobject>
                        <imagedata fileref="images/admin/web-harvesting-where.png" width="11cm" align="center"/>
                    </imageobject>
                </mediaobject>
            </figure>

            <para><xref linkend="admin_harvesting_list"/> shows the harvesting main page. The page
                shows a list of harvesting nodes that have been created so far. On the bottom side
                there is a set of buttons to manage these nodes. The meaning of each column is as
                follows:</para>
                
            <orderedlist>
                <listitem>
                	<para><emphasis>Select</emphasis> This is just a check box to select one or more nodes. The selected nodes
                		will be affected by the first row of buttons (start, stop, run, remove). For
        		        example, if you select 3 nodes and press the Remove button, these 3 nodes will be
		                removed.</para>
                </listitem>
                <listitem>
            		<para><emphasis>Name</emphasis> This is the node’s name provided by the administrator.</para>
                </listitem>
                <listitem>
                    <para><emphasis>Type</emphasis> The node’s harvesting type chosen when the node was 
                        created (GeoNetwork, web folder etc...).</para>
                </listitem>
                <listitem>
            		<para><emphasis>Status</emphasis> This is an icon that reflects the node’s current status. See <xref
                    	linkend="admin_harvesting_status"/> for all different icons and status
                    	description.</para>
                </listitem>
                <listitem>
            		<para><emphasis>Errors</emphasis> This column reflects the status of the last harvesting run,
                		which could have succeeded or not. The result is reflected on this icon and a
                		tool tip will show detailed information. See <xref
                		linkend="admin_harvesting_status_2"/> for all different icons.</para>
                </listitem>
                <listitem>
            		<para><emphasis>Every</emphasis> The time (in days, hours, minutes) between two consecutive harvesting 
            	from this node.</para>
                </listitem>
                <listitem>
            		<para><emphasis>Last run</emphasis> The date, in ISO 8601 format, of the most recent harvesting run. </para>
                </listitem>
                <listitem>
        		    <para><emphasis>Operation</emphasis> A list of buttons for all possible operations on a node.</para>
                </listitem>
                <listitem>
		            <para>Selecting <emphasis>Edit</emphasis> will allow you to change the parameters for a node.</para>
                </listitem>
            </orderedlist>

            <figure id="admin_harvesting_list">
                <title>The harvesting main page</title>
                <mediaobject>
                    <imageobject>
                        <imagedata fileref="images/admin/web-harvesting-list.png" width="11cm" align="center"/>
                    </imageobject>
                </mediaobject>
            </figure>

            <para>The bottom side of the page contains two rows of buttons. The first row contains buttons 
                that can operate on a set of nodes. You can select the nodes using the check box on the first 
                column and then press the proper button. When the button finishes its action, the check boxes 
                are cleared. Here is the meaning of each button:</para>

            <orderedlist>
                <listitem>
            <para><emphasis>Activate</emphasis> When a new harvesting node is created, it’s status is
                <emphasis>inactive</emphasis>. Use this button to make it
                <emphasis>active</emphasis> and thus to start harvesting from the remote node.</para>
                </listitem>
                <listitem>
            <para><emphasis>Deactivate</emphasis> Stops harvesting from a node. Please notice that this does not mean that
                a currently running harvesting will be stopped but it means that this node will be
                ignored during future harvesting.</para>
                </listitem>
                <listitem>
            <para><emphasis>Run</emphasis> This button simply tells the harvesting
                engine to start harvesting immediately. This is useful for testing during the
                harvesting setup.</para>
                </listitem>
                <listitem>
            <para><emphasis>Remove</emphasis> Remove all currently selected nodes. A dialogue will ask the
            user to confirm the action.</para>
                </listitem>
            </orderedlist>

            <para>The second row contains general purpose buttons. Here is the meaning of each button:</para>

            <orderedlist>
                <listitem>
            <para><emphasis>Back</emphasis> Simply returns to the main administration page.</para>
                </listitem>
                <listitem>
            <para><emphasis>Add</emphasis> This button allows to create new harvesting nodes.</para>
                </listitem>
                <listitem>
            <para><emphasis>Refresh</emphasis> Refreshes the current list of nodes querying the server. This
                can be useful to see if the harvesting list has been altered by someone else or if
                any harvesting process started.</para>
                </listitem>
            </orderedlist>

           <table frame="all" id="admin_harvesting_status">
               <title>Possible status icons</title><?dbhtml table-width="75%" ?>
                <tgroup cols="3">
                    <colspec colnum="1" colname="c1" align="center" colwidth="1*"/>
                    <colspec colnum="2" colname="c2" align="left" colwidth="1.5*"/>
                    <colspec colnum="3" colname="c3" align="left" colwidth="5.5*"/>
                    <thead>
                        <row>
                            <entry>
                                <para>Icon</para>
                            </entry>
                            <entry>
                                <para>Status</para>
                            </entry>
                            <entry>
                                <para>Description</para>
                            </entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>
                                <para>
                                    <inlinegraphic fileref="images/icons/fileclose.png"/>
                               </para>
                            </entry>
                            <entry>
                                <para>Inactive</para>
                            </entry>
                            <entry>
                                <para>The harvesting from this node is stopped.</para>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <para>
                                    <inlinegraphic fileref="images/icons/clock.png"/>
                               </para>
                            </entry>
                            <entry>
                                <para>Active</para>
                            </entry>
                            <entry>
                                <para>The harvesting engine is waiting for the timeout specified for
                                    this node. When the timeout is reached, the harvesting
                                starts.</para>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <para>
                                    <inlinegraphic fileref="images/icons/exec.png"/>
                               </para>
                            </entry>
                            <entry>
                                <para>Running</para>
                            </entry>
                            <entry>
                                <para>The harvesting engine is currently running, fetching metadata
                                    from remote nodes. When the process will be finished, the status
                                    will be switched to active.</para>
                            </entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>

            <table frame="all" id="admin_harvesting_status_2">
                <title>Possible error icons</title><?dbhtml table-width="75%" ?>
                <tgroup cols="2">
                    <colspec colnum="1" colname="c1" align="center" colwidth="1*"/>
                    <colspec colnum="2" colname="c2" align="left" colwidth="7*"/>
                    <thead>
                        <row>
                            <entry>
                                <para>Icon</para>
                            </entry>
                            <entry>
                                <para>Description</para>
                            </entry>
                        </row>
                        </thead>
                    <tbody>
                        <row>
                            <entry>
                                <para>
                                    <inlinegraphic fileref="images/icons/button_ok.png"/>
                               </para>
                            </entry>
                            <entry>
                                <para>The harvesting was OK, no errors were found. In this case, a
                                    tool tip will show some harvesting results (like the number of
                                    harvested metadata etc...).</para>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <para>
                                    <inlinegraphic fileref="images/icons/important.png"/>
                               </para>
                            </entry>
                            <entry>
                                <para>The harvesting was aborted due to an unexpected condition. In
                                    this case, a tool tip will show some information about the
                                error.</para>
                            </entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>

            <section>
                <title>Harvesting result tips</title>
                <para>If the harvesting succeeds, a tool tip will show detailed information about the
                    harvesting process. This way you can check if the harvester worked as expected
                    or if there is something to fix to the harvesting parameters or somewhere else.
                    The result tip is like a table, where each row refers to</para>
                <para>Total This is the total number of metadata found remotely. Metadata with the
                    same id are considered as one. Added Number of metadata added to the system
                    because they were not present locally. Removed Number of metadata that have been
                    removed locally because they are not present in the remote server anymore.
                    Updated Number of metadata that are present locally but that needed to be
                    updated because their last change date was different from the remote one.
                    Unchanged Local metadata left unchanged. Their remote last change date did not
                    change. Unknown schema Number of skipped metadata because their format was not
                    recognised by GeoNetwork. Unretrievable Number of metadata that were ready to be
                    retrieved from the remote server but for some reason there was an exception
                    during the data transfer process. Bad Format Number of skipped metadata because
                    they did not have a valid XML representation. Does not validate Number of
                    metadata which did not validate against their schema. These metadata were
                    harvested with success but skipped due to the validation process. Usually,
                    there is an option to force validation: if you want to harvest these metadata
                    anyway, simply turn it off.</para>

                <table frame="all" id="admin_harvesting_support">
                    <title>Result information supported by harvesting types</title><?dbhtml table-width="90%" ?>
                    <tgroup cols="5">
                        <colspec colnum="1" colname="c1" align="left" colwidth="2*"/>
                        <colspec colnum="2" colname="c2" align="center" colwidth="1*"/>
                        <colspec colnum="3" colname="c3" align="center" colwidth="1*"/>
                        <colspec colnum="4" colname="c4" align="center" colwidth="1*"/>
                        <colspec colnum="5" colname="c5" align="center" colwidth="1*"/>
                        <thead>
                            <row>
                                <entry>
                                    <para>Result vs harvesting type</para>
                                </entry>
                                <entry>
                                    <para>GeoNetwork</para>
                                </entry>
                                <entry>
                                    <para>WebDAV</para>
                                </entry>
                                <entry>
                                    <para>CSW</para>
                                </entry>
                                <entry>
                                    <para>OAI-PMH</para>
                                </entry>
                                <entry>
                                    <para>OGC Service</para>
                                </entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>
                                    <para>Total</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para>Added</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para>Removed</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para>Updated</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para></para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para>Unchanged</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para></para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para>Unknown schema</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para>Unretrievable</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para>Bad Format</para>
                                </entry>
                                <entry> </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry> </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para>Does Not Validate</para>
                                </entry>
                                <entry> </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry> </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                                <entry>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para>Thumbnails / Thumbnails failed</para>
                                </entry>
                                <entry> </entry>
                                <entry>
                                </entry>
                                <entry> </entry>
                                <entry>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <para>Metadata URL attribute used</para>
                                </entry>
                                <entry> </entry>
                                <entry>
                                </entry>
                                <entry> </entry>
                                <entry>
                                </entry>
                                <entry>
                                    <para>x</para>
                                </entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>

            </section>
        </section>
        <section>
            <title>Adding new nodes</title>
            <para>The Add button in the main page allows you to add new harvesting nodes. It will 
            	open the form shown in <xref linkend="admin_harvesting_add"/>. 
            	When creating a new node, you have to choose the harvesting protocol supported
                by the remote server. The supported protocols are:</para>
            <orderedlist>
                <listitem>
            <para><emphasis>GeoNetwork 2.1 remote node</emphasis> This is the standard and most powerful 
            	harvesting protocol used in GeoNetwork. It is able to log in into the remote node, to perform 
            	a standard search using the common query fields and to import all matching metadata. 
            	Furthermore, the protocol will try to keep both remote privileges and categories of 
            	the harvested metadata if they exist locally. Please notice that since GeoNetwork 2.1 
            	the harvesting protocol has been improved. This means that it is not possible to use 
            	this protocol to harvest from version 2.0 or below.</para>
            	</listitem>
            	<listitem>
            <para><emphasis>Web DAV server</emphasis> This harvesting type
                uses the web DAV (Distributed Authoring and Versioning) protocol to harvest metadata
                from a DAV server. It can be useful to users that want to publish their metadata
                through a web server that offers a DAV interface. The protocol allows to retrieve
                the contents of a web page (a list of files) with their change date.</para>
            	</listitem>
            	<listitem>
            <para><emphasis>Catalogue Services for the Web 2.0</emphasis> The Open Geospatial Consortium 
            	Catalogue Services for the Web and it is a search interface for catalogues developed by 
            	the Open Geospatial Consortium. GeoNetwork implements version 2.0 of this protocol.</para>
            	</listitem>
            	<listitem>
            <para><emphasis>GeoNetwork v2.0 remote node</emphasis> GeoNetwork 2.1 introduced a new 
            	powerful harvesting engine which is not compatible with GeoNetwork version 2.0 based 
            	catalogues. Old 2.0 servers can still harvest from 2.1 servers but harvesting metadata 
            	from a v2.0 server requires this harvesting type. This harvesting type is 
            	deprecated.</para>
            	</listitem>
            	<listitem>
            <para><emphasis>Z3950 Remote search</emphasis> Not implemented. This is a placeholder.</para>
            	</listitem>
            	<listitem>
            <para><emphasis>OAI Protocol for Metadata Harvesting 2.0</emphasis> This is a good 
            	harvesting protocol that is widely used among libraries. GeoNetwork implements version 
            	2.0 of the protocol.</para>
            	</listitem>
            </orderedlist>
            <para>The drop down list shows all available protocols. Pressing the Add button you will
                reach an edit page whose content depends on the chosen protocol. The Back button
                will go back to the main page.</para>

            <figure id="admin_harvesting_add">
                <title>Adding a new harvesting node</title>
                <mediaobject>
                    <imageobject>
                        <imagedata fileref="images/admin/web-harvesting-add.png" width="12cm" align="center"/>
                    </imageobject>
                </mediaobject>
            </figure>

            <section>
                <title>Adding a GeoNetwork node</title>
                <para>This type of harvesting allows you to connect to a GeoNetwork node, perform a
                    simple search as in the main page and retrieve all matched metadata. The search
                    is useful because it allows you to focus only on metadata of interest. Once you
                    add a node of this type, you will get a page like the one shown in <xref
                        linkend="admin_harvesting_gn"/>. The meaning of the options is the
                    following:</para>

                <figure id="admin_harvesting_gn">
                    <title>Adding a GeoNetwork node</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata fileref="images/admin/web-harvesting-gn.png" width="11cm" align="center"/>
                        </imageobject>
                    </mediaobject>
                </figure>

                <para>Site Here you put information about the GeoNetwork’s node you want to harvest
                    from (host, port and servlet). If you want to search protected metadata you have
                    to specify an account. The name parameter is just a short description that will
                    be shown in the main page beside each node. Search In this section you can
                    specify search parameters: they are the same present in the main page. Before
                    doing that, it is important to remember that the GeoNetwork’s harvesting can be
                    hierarchical so a remote node can contain both its metadata and metadata
                    harvested from other nodes and sources. At the beginning, the Source drop down
                    is empty and you have to use the Retrieve sources button to fill it. The purpose
                    of this button is to query GeoNetwork about all sources which it is currently
                    harvesting from. Once you get the drop down filled, you can choose a source name
                    to constrain the search to that source only. Leaving the drop down blank, the
                    search will spread over all metadata (harvested and not). You can add several
                    search criteria for each site through the Add button: several searches will be
                    performed and results merged. Each search box can be removed pressing the small
                    button on the left of the site’s name. If no search criteria is added, a global
                    unconstrained search will be performed. Options This is just a container for
                    general options.</para>
                <para>Every This is the harvesting period. The smallest value is 1 minute while the
                    greatest value is 100 days. One run only If this option is checked, the
                    harvesting will do only one run after which it will become inactive. Privileges
                    Here you decide how to map remote group’s privileges. You can assign a copy
                    policy to each group. The Intranet group is not considered because it does not
                    make sense to copy its privileges. The All group has different policies from all
                    the others:</para>

                <orderedlist>
                    <listitem>
                        <para>Copy: Privileges are copied.</para>
                    </listitem>
                    <listitem>
                        <para>Copy to Intranet: Privileges are copied but to the Intranet group.
                            This way public metadata can be made protected.</para>
                    </listitem>
                    <listitem>
                        <para>Don’t copy: Privileges are not copied and harvested metadata will not
                            be publicly visible.</para>
                    </listitem>
                </orderedlist>
                <para>For all other groups the policies are these:</para>

                <orderedlist>
                    <listitem>
                        <para>Copy: Privileges are copied only if there is a local group with the
                            same (not localised) name as the remote group.</para>
                    </listitem>
                    <listitem>
                        <para>Create and copy: Privileges are copied. If there is no local group
                            with the same name as the remote group then it is created.</para>
                    </listitem>
                    <listitem>
                        <para>Don’t copy: Privileges are not copied.</para>
                    </listitem>
                </orderedlist>
                <para>On the bottom side of the page there are some buttons:</para>
                <para>Back Simply return to the main harvesting page. Save Saves the current node
                    information and returns to the main harvesting page. When creating a new node,
                    the node will be actually created only when you press this button.</para>

            </section>
            <section>
                <title>Adding a Web DAV node</title>
                <para>In this type of harvesting, metadata are retrieved from a remote web page. The
                    available options are shown in <xref linkend="admin_harvesting_webdav"/> and
                    have the following meaning:</para>

                <figure id="admin_harvesting_webdav">
                    <title>Adding a web DAV node</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata fileref="images/admin/web-harvesting-webdav.png" width="11cm" align="center"/>
                        </imageobject>
                    </mediaobject>
                </figure>

                <para>Site Here are the connection information. The available options are:</para>
                <para>Name This is a short description of the node. It will be shown in the
                    harvesting main page. URL The remote URL from which metadata will be harvested.
                    Each file found that ends with .xml will indicate a metadata and will be
                    retrieved, converted into XML and imported. Icon Just an icon to assign to
                    harvested metadata. The icon will be used when showing search results. Use
                    account Account credentials for a basic HTTP authentication toward the remote
                    URL. Options General harvesting options:</para>
                <para>Every This is the harvesting period. The smallest value is 1 minute while the
                    greatest value is 100 days. One run only If this option is checked, the
                    harvesting will do only one run after which it will become inactive. Validate If
                    checked, the metadata will be validate during import. If the validation does not
                    pass, the metadata will be skipped. Recurse When the harvesting engine will find
                    folders, it will recursively descend into them. Privileges Here it is possible
                    to assign privileges to imported metadata. The Groups area lists all available
                    groups in GeoNetwork. Once one (or more) group has been selected, it can be
                    added through the Add button (each group can be added only once). For each added
                    group, a row of privileges is created at the bottom of the list to allow
                    privilege selection. To remove a row simply press the associated Remove button
                    on its right. Categories Here you can assign local categories to harvested
                    metadata.</para>
                <para>At the bottom of the page there are the following buttons:</para>
                <para>Back Go back to the main harvesting page. The harvesting is not added. Save
                    Saves node’s data creating a new harvesting node. Then it will go back to the
                    main harvesting page.</para>

            </section>
            <section>
                <title>Adding a CSW node</title>
                <para>This type of harvesting is capable of connecting to a remote CSW server and
                    retrieving all matching metadata. Please, note that in order to be harvested
                    metadata must have one of the schema format handled by GeoNetwork. <xref
                        linkend="admin_harvesting_csw"/> shows the options available, whose meaning
                    is the following:</para>

                <figure id="admin_harvesting_csw">
                    <title>Adding a Catalogue Services for the Web harvesting node</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata fileref="images/admin/web-harvesting-csw.png" width="11cm" align="center"/>
                        </imageobject>
                    </mediaobject>
                </figure>

                <para>Site Here you have to specify the connection parameters which are similar to
                    the web DAV harvesting. In this case the URL points to the capabilities document
                    of the CSW server. This document is used to discover the location of the
                    services to call to query and retrieve metadata. Search Using the Add button,
                    you can add several search criteria. You can query only the fields recognised by
                    the CSW protocol. Options General harvesting options:</para>
                <para>Every This is the harvesting period. The smallest value is 1 minute while the
                    greatest value is 100 days. One run only If this option is checked, the
                    harvesting will do only one run after which it will become inactive. Privileges
                    Please, see web DAV harvesting. Categories Please, see web DAV harvesting.</para>
                <para>At the bottom of the page there are the following buttons:</para>
                <para>Back Go back to the main harvesting page. The harvesting is not added. Save
                    Saves node’s data creating a new harvesting node. Then it will go back to the
                    main harvesting page.</para>

            </section>
            <section>
                <title>Adding an OAI-PMH node</title>
                <para>An OAI-PMH server implements a harvesting protocol that GeoNetwork, acting as
                    a client, can use to harvest metadata. If you are requesting the oai_dc output
                    format, GeoNetwork will convert it into its Dublin Core format. Other formats
                    can be harvested only if GeoNetwork supports them and is able to autodetect the
                    schema from the metadata. <xref linkend="admin_harvesting_oaipmh"/> shows all
                    available options, which are:</para>

                <figure id="admin_harvesting_oaipmh">
                    <title> Adding an OAI-PMH harvesting node </title>
                    <mediaobject>
                        <imageobject>
                            <imagedata fileref="images/admin/web-harvesting-oaipmh.png" width="11cm" align="center"/>
                        </imageobject>
                    </mediaobject>
                </figure>

                <para>Site All options are the same as web DAV harvesting. The only difference is
                    that the URL parameter here points to an OAI-PMH server. This is the entry point
                    that GeoNetwork will use to issue all PMH commands. Search This part allows you
                    to restrict the harvesting to specific metadata subsets. You can specify several
                    searches: GeoNetwork will execute them sequentially and results will be merged
                    to avoid the harvesting of the same metadata. Several searches allow you to
                    specify different search criteria. In each search, you can specify the following
                    parameters:</para>
                <para>From You can provide a start date here. All metadata whose last change date is
                    equal to or greater than this date will be harvested. You cannot simply edit
                    this field but you have to use the <inlinegraphic
                        fileref="images/icons/calendar.gif"/> icon to popup a calendar and choose
                    the date. This field is optional so if you don’t provide it the start date
                    constraint is dropped. Use the <inlinegraphic
                        fileref="images/icons/clear_left.png"/> icon to clear the field. Until Works
                    exactly as the from parameter but adds an end constraint to the last change
                    date. The until date is included in the date range, the check is: less than or
                    equal to. Set An OAI-PMH server classifies its metadata into hierarchical sets.
                    You can request to return metadata that belong to only one set (and its
                    subsets). This narrows the search result. Initially the drop down shows only a
                    blank option that indicate <emphasis>no set</emphasis>. After specifying the
                    connection URL, you can press the Retrieve Info button, whose purpose is to
                    connect to the remote node, retrieve all supported sets and prefixes and fill
                    the search drop downs. After you have pressed this button, you can select a
                    remote set from the drop down. Prefix Here prefix means metadata format. The
                    oai_dc prefix is mandatory for any OAI-PMH compliant server, so this entry is
                    always present into the prefix drop down. To have this drop down filled with all
                    prefixes supported by the remote server, you have to enter a valid URL and press
                    the Retrieve Info button.</para>
                <para>You can use the Add button to add one more search to the list. A search can be
                    removed clicking the <inlinegraphic fileref="images/icons/fileclose.png"/> icon
                    on its left. Options Most options are common to web DAV harvesting. The validate
                    option, when checked, will validate each harvested metadata against GeoNetwork’s
                    schemas. Only valid metadata will be harvested. Invalid one will be skipped.
                    Privileges Please, see web DAV harvesting. Categories Please, see web DAV
                    harvesting.</para>
                <para>At the bottom of the page there are the following buttons:</para>
                <para>Back Go back to the main harvesting page. The harvesting is not added. Save
                    Saves node’s data creating a new harvesting node. Then it will go back to the
                    main harvesting page.</para>
                <para>Please note that when you edit a previously created node, both the
                        <emphasis>set</emphasis> and <emphasis>prefix</emphasis> drop down lists
                    will be empty. They will contain only the previously selected entries, plus the
                    default ones if they were not selected. Furthermore, the set name will not be
                    localised but the internal code string will be displayed. You have to press the
                    retrieve info button again to connect to the remote server and retrieve the
                    localised name and all set and prefix information.</para>
            </section>
            <section>
                <title>Adding an OGC Service (ie. WMS, WFS, WCS)</title>
                <para>An OGC service implements a GetCapabilities operation that GeoNetwork, acting as
                    a client, can use to produce metadata. The GetCapability document provides information about the
                    service and the layers/feature types/coverages served. GeoNetwork will convert it into
                    ISO19139/119 format. <xref linkend="admin_harvesting_ogc"/> shows all
                    available options, which are:</para>

                <figure id="admin_harvesting_ogc">
                    <title> Adding an OGC service harvesting node </title>
                    <mediaobject>
                        <imageobject>
                            <imagedata fileref="images/admin/web-harvesting-ogc.png" width="11cm" align="center"/>
                        </imageobject>
                    </mediaobject>
                </figure>

                <para>Site: Name is the name of the catalogue and will be one of the search criteria. 
                    The type of OGC service indicates if the harvester has to query for a specific kind of service.
                    Supported type are WMS (1.0.0 and 1.1.1), WFS (1.0.0 and 1.1.0, WCS (1.0.0) and WPS (0.4.0 and
                    1.0.0). The service URL is the URL of the service to contact (without parameters like 
                    "REQUEST=GetCapabilities", "VERSION=", ...). It has to be a valid URL 
                    like http://your.preferred.ogcservice/type_wms. 
                    The metadata language has to be specified. It will define the language of the metadata.
                    It should be the language used by the web service administrator.
                    The ISO topic category is used to populate the metadata. It is recommended to choose on
                    as the topic is mandatory for the ISO standard if the hierarchical level is "datasets".
                </para>
                <para>
                    The type of import allows to define if the harvester has to produce only one metadata
                    for the service or if it should loop over datasets served by the service and produce
                    also metadata for each datasets. For each dataset the second checkbox allow to generate
                    metadata for the dataset using an XML document referenced in the MetadataUrl attribute
                    of the dataset in the GetCapability document. If this document is loaded but it is not valid
                    (ie. unknown schema, bad XML format), the GetCapability document is used.
                    For WMS, thumbnails could be created during harvesting.
                </para>
                <para> 
                    Icons and privileges are defined as in the other harvester types.
                </para>
                <para>
                    Metadata for the harvested service is linked to the category selected for the service 
                    (usually "interactive resources" should be the best category). 
                    For each dataset, the "category for datasets" is linked to each metadata for datasets.
                </para>
            </section>
        </section>
    </chapter>
</book>
